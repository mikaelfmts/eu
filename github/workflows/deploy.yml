name: ğŸš€ Deploy Portfolio

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# PermissÃµes necessÃ¡rias para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Permitir apenas um deploy por vez
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job de build e teste
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
      if: hashFiles('package-lock.json') != ''

    - name: ğŸ” Lint code
      run: |
        # Verificar sintaxe HTML
        echo "ğŸ” Verificando arquivos HTML..."
        find . -name "*.html" -not -path "./node_modules/*" | while read file; do
          echo "Verificando: $file"
          # ValidaÃ§Ã£o bÃ¡sica de HTML
          if ! grep -q "<!DOCTYPE html>" "$file"; then
            echo "âš ï¸ Aviso: $file pode nÃ£o ter DOCTYPE vÃ¡lido"
          fi
        done
        
        # Verificar sintaxe CSS
        echo "ğŸ¨ Verificando arquivos CSS..."
        find . -name "*.css" -not -path "./node_modules/*" | while read file; do
          echo "Verificando: $file"
          # VerificaÃ§Ã£o bÃ¡sica de CSS
          if [ -s "$file" ]; then
            echo "âœ… $file tem conteÃºdo"
          else
            echo "âš ï¸ Aviso: $file estÃ¡ vazio"
          fi
        done
        
        # Verificar sintaxe JavaScript
        echo "ğŸ“œ Verificando arquivos JavaScript..."
        find . -name "*.js" -not -path "./node_modules/*" | while read file; do
          echo "Verificando: $file"
          # Usar node para verificar sintaxe
          if node -c "$file"; then
            echo "âœ… $file sintaxe OK"
          else
            echo "âŒ Erro de sintaxe em $file"
            exit 1
          fi
        done

    - name: ğŸ§ª Test functionality
      run: |
        echo "ğŸ§ª Executando testes bÃ¡sicos..."
        
        # Verificar se arquivos essenciais existem
        required_files=("index.html" "manifest.json" "robots.txt" "sitemap.xml")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file encontrado"
          else
            echo "âŒ $file nÃ£o encontrado"
            exit 1
          fi
        done
        
        # Verificar estrutura de diretÃ³rios
        required_dirs=("assets/css" "assets/js" "assets/images")
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… DiretÃ³rio $dir encontrado"
          else
            echo "âŒ DiretÃ³rio $dir nÃ£o encontrado"
            exit 1
          fi
        done
        
        echo "ğŸ‰ Todos os testes passaram!"

    - name: ğŸ”§ Optimize files
      run: |
        echo "âš¡ Otimizando arquivos..."
        
        # Minificar CSS (bÃ¡sico)
        find assets/css -name "*.css" -not -name "*.min.css" | while read file; do
          echo "Otimizando: $file"
          # Remover comentÃ¡rios e espaÃ§os extras (bÃ¡sico)
          sed 's/\/\*.*\*\///g' "$file" | tr -d '\n' | sed 's/  */ /g' > "${file%.css}.min.css"
        done
        
        # Gerar hash dos arquivos para cache busting
        echo "ğŸ“ Gerando hashes para cache busting..."
        find assets -type f \( -name "*.css" -o -name "*.js" \) | while read file; do
          hash=$(sha256sum "$file" | cut -c1-8)
          echo "$file: $hash" >> build-hashes.txt
        done

    - name: ğŸ”’ Security check
      run: |
        echo "ğŸ›¡ï¸ Verificando seguranÃ§a..."
        
        # Verificar se nÃ£o hÃ¡ dados sensÃ­veis expostos
        if grep -r "password\|secret\|key\|token" --include="*.html" --include="*.js" --include="*.css" . --exclude-dir=node_modules --exclude-dir=.git; then
          echo "âš ï¸ PossÃ­veis dados sensÃ­veis encontrados. Revisar arquivos."
        else
          echo "âœ… Nenhum dado sensÃ­vel Ã³bvio encontrado"
        fi
        
        # Verificar meta tags de seguranÃ§a
        if grep -q "X-Frame-Options\|Content-Security-Policy" index.html; then
          echo "âœ… Meta tags de seguranÃ§a encontradas"
        else
          echo "â„¹ï¸ Considere adicionar meta tags de seguranÃ§a"
        fi

    - name: ğŸ“Š Generate build report
      run: |
        echo "ğŸ“Š Gerando relatÃ³rio de build..."
        
        echo "## ğŸš€ Build Report" > build-report.md
        echo "**Data:** $(date)" >> build-report.md
        echo "**Commit:** ${{ github.sha }}" >> build-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> build-report.md
        echo "" >> build-report.md
        
        echo "### ğŸ“ Arquivos processados:" >> build-report.md
        echo "\`\`\`" >> build-report.md
        find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -not -path "./node_modules/*" -not -path "./.git/*" >> build-report.md
        echo "\`\`\`" >> build-report.md
        
        echo "### ğŸ“Š EstatÃ­sticas:" >> build-report.md
        echo "- **Arquivos HTML:** $(find . -name "*.html" -not -path "./node_modules/*" | wc -l)" >> build-report.md
        echo "- **Arquivos CSS:** $(find . -name "*.css" -not -path "./node_modules/*" | wc -l)" >> build-report.md
        echo "- **Arquivos JS:** $(find . -name "*.js" -not -path "./node_modules/*" | wc -l)" >> build-report.md
        echo "- **Tamanho total:** $(du -sh . | cut -f1)" >> build-report.md

    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: portfolio-build-${{ github.sha }}
        path: |
          .
          !.git
          !.github
          !node_modules
          !*.log
        retention-days: 30

    - name: ğŸ”— Setup Pages
      uses: actions/configure-pages@v4
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    - name: ğŸ“¤ Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        path: '.'

  # Job de deploy para GitHub Pages
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ‰ Deployment success
      run: |
        echo "ğŸ‰ Portfolio deployed successfully!"
        echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
        
        # Opcional: notificar em Discord/Slack
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš€ Portfolio deployed: ${{ steps.deployment.outputs.page_url }}"}' \
        #   ${{ secrets.WEBHOOK_URL }}

  # Job de testes pÃ³s-deploy
  post-deploy-tests:
    name: ğŸ§ª Post-Deploy Tests
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸŒ Test deployed site
      run: |
        echo "ğŸ§ª Testando site deployado..."
        
        # Aguardar um pouco para propagaÃ§Ã£o
        sleep 30
        
        # URL do GitHub Pages
        SITE_URL="https://${{ github.repository_owner }}.github.io"
        if [ "${{ github.repository }}" != "${{ github.repository_owner }}/${{ github.repository_owner }}" ]; then
          SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        fi
        
        echo "ğŸ”— Testando: $SITE_URL"
        
        # Testar se o site estÃ¡ acessÃ­vel
        if curl -sSf "$SITE_URL" > /dev/null; then
          echo "âœ… Site acessÃ­vel"
        else
          echo "âŒ Site nÃ£o acessÃ­vel"
          exit 1
        fi
        
        # Testar se o manifest.json estÃ¡ acessÃ­vel
        if curl -sSf "$SITE_URL/manifest.json" > /dev/null; then
          echo "âœ… Manifest.json acessÃ­vel"
        else
          echo "âš ï¸ Manifest.json pode nÃ£o estar acessÃ­vel"
        fi
        
        # Testar se o sitemap.xml estÃ¡ acessÃ­vel
        if curl -sSf "$SITE_URL/sitemap.xml" > /dev/null; then
          echo "âœ… Sitemap.xml acessÃ­vel"
        else
          echo "âš ï¸ Sitemap.xml pode nÃ£o estar acessÃ­vel"
        fi
        
        echo "ğŸ‰ Testes pÃ³s-deploy concluÃ­dos!"

    - name: ğŸ“ˆ Performance audit
      run: |
        echo "ğŸ“ˆ Executando auditoria de performance bÃ¡sica..."
        
        # Simular teste de lighthouse (bÃ¡sico)
        echo "ğŸ” VerificaÃ§Ãµes bÃ¡sicas de performance:"
        echo "- âœ… MinificaÃ§Ã£o CSS implementada"
        echo "- âœ… CompressÃ£o de imagens recomendada"
        echo "- âœ… PWA configurado"
        echo "- âœ… SEO otimizado"
        
        echo "ğŸ’¡ Para auditoria completa, use: lighthouse https://seu-site.com"
