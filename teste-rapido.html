<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Teste R√°pido CORS</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            font-weight: bold; 
        }
        .success { background: #28a745; }
        .error { background: #dc3545; }
        .warning { background: #ffc107; color: #000; }
        .info { background: #17a2b8; }
        button { 
            background: #c8aa6e; 
            color: #000; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #d4b974; }
        input[type="file"] { margin: 10px 0; color: #fff; }
        .progress { 
            width: 100%; 
            height: 20px; 
            background: #333; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        .progress-bar { 
            height: 100%; 
            background: #c8aa6e; 
            width: 0%; 
            transition: width 0.3s; 
        }
    </style>
</head>
<body>
    <h1>üöÄ Teste R√°pido CORS</h1>
    <p>Status das configura√ß√µes Firebase Storage:</p>

    <div id="status-container">
        <div class="status info">‚è≥ Verificando configura√ß√µes...</div>
    </div>

    <div style="margin: 20px 0;">
        <input type="file" id="test-file" accept="image/*,video/*" style="margin-bottom: 10px;">
        <br>
        <button onclick="quickTest()" id="test-btn">üß™ Teste R√°pido</button>
        <button onclick="location.href='debug-cors.html'">üîß Diagn√≥stico Completo</button>
    </div>

    <div id="progress-container" style="display: none;">
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="progress-text">0%</div>
    </div>

    <div id="result-container"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA0VoWMLTJIyI54Pj0P5T75gCH6KpgAcbk",
            authDomain: "mikaelfmts.firebaseapp.com",
            projectId: "mikaelfmts",
            storageBucket: "mikaelfmts.appspot.com",
            messagingSenderId: "516762612351",
            appId: "1:516762612351:web:f8a0f229ffd5def8ec054a"
        };

        let app, storage, auth;
        let isReady = false;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                storage = getStorage(app);
                auth = getAuth(app);
                
                // Login autom√°tico
                await signInAnonymously(auth);
                
                updateStatus('success', '‚úÖ Firebase configurado e autenticado!');
                isReady = true;
            } catch (error) {
                updateStatus('error', `‚ùå Erro na configura√ß√£o: ${error.message}`);
            }
        }

        function updateStatus(type, message) {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        window.quickTest = async function() {
            const fileInput = document.getElementById('test-file');
            const testBtn = document.getElementById('test-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultContainer = document.getElementById('result-container');

            if (!fileInput.files[0]) {
                alert('Selecione um arquivo primeiro!');
                return;
            }

            if (!isReady) {
                alert('Firebase n√£o est√° pronto. Aguarde a configura√ß√£o.');
                return;
            }

            const file = fileInput.files[0];
            testBtn.disabled = true;
            testBtn.textContent = 'üîÑ Testando...';
            progressContainer.style.display = 'block';
            resultContainer.innerHTML = '';

            try {
                // Validar arquivo
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('Arquivo muito grande (m√°ximo 10MB)');
                }

                // Preparar upload
                const fileName = `test-quick/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, fileName);

                // Upload
                const uploadTask = uploadBytesResumable(storageRef, file, {
                    contentType: file.type,
                    cacheControl: 'public, max-age=31536000'
                });

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${progress.toFixed(1)}%`;
                    },
                    (error) => {
                        console.error('Erro no upload:', error);
                        
                        let message = '‚ùå FALHA NO TESTE';
                        if (error.code === 'storage/unauthorized' || 
                            error.message.includes('CORS') || 
                            error.message.includes('XMLHttpRequest')) {
                            message += '<br><br>üö® <strong>PROBLEMA DE CORS DETECTADO!</strong><br>' +
                                      'As regras do Firebase Storage n√£o foram aplicadas.<br><br>' +
                                      '<strong>SOLU√á√ÉO:</strong><br>' +
                                      '1. Abra: <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a><br>' +
                                      '2. V√° para Storage ‚Üí Rules<br>' +
                                      '3. Cole o conte√∫do do arquivo firebase-rules.txt<br>' +
                                      '4. Clique em "Publicar"<br>' +
                                      '5. Aguarde 5-10 minutos';
                        } else {
                            message += `<br><br>Erro: ${error.message}`;
                        }
                        
                        resultContainer.innerHTML = `<div class="status error">${message}</div>`;
                    },
                    async () => {
                        try {
                            const url = await getDownloadURL(storageRef);
                            resultContainer.innerHTML = `
                                <div class="status success">
                                    üéâ <strong>TESTE PASSOU!</strong><br><br>
                                    ‚úÖ CORS funcionando corretamente<br>
                                    ‚úÖ Upload realizado com sucesso<br>
                                    ‚úÖ URL gerada: <a href="${url}" target="_blank">Ver arquivo</a><br><br>
                                    <strong>Seu sistema est√° funcionando!</strong>
                                </div>
                            `;
                        } catch (urlError) {
                            resultContainer.innerHTML = `
                                <div class="status warning">
                                    ‚ö†Ô∏è Upload realizado mas erro ao obter URL<br>
                                    Erro: ${urlError.message}
                                </div>
                            `;
                        }
                    }
                );

            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="status error">
                        ‚ùå Erro no teste: ${error.message}
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üß™ Teste R√°pido';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                }, 2000);
            }
        };

        // Inicializar automaticamente
        initFirebase();
    </script>

    <div style="margin-top: 30px; padding: 15px; background: #333; border-radius: 8px;">
        <h3>üìã Instru√ß√µes:</h3>
        <ol>
            <li>Selecione uma imagem ou v√≠deo pequeno (< 10MB)</li>
            <li>Clique em "Teste R√°pido"</li>
            <li>Se falhar com erro de CORS, siga as instru√ß√µes mostradas</li>
            <li>Se passar, seu sistema est√° funcionando!</li>
        </ol>
        
        <p><strong>‚ö° Este √© um teste simplificado.</strong><br>
        Para diagn√≥stico completo, use o <a href="debug-cors.html">Diagn√≥stico Completo</a>.</p>
    </div>
</body>
</html>
