<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Certificados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Debug - Certificados no Firebase</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Controles</h2>
            <div class="flex gap-4">
                <button onclick="loadAllCertificates()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync mr-2"></i>Carregar Certificados
                </button>
                <button onclick="cleanupProblematicCertificates()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-trash mr-2"></i>Limpar Certificados Problemáticos
                </button>
            </div>
        </div>

        <div id="loading" class="bg-white rounded-lg shadow p-6 hidden">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                <p class="mt-2">Carregando...</p>
            </div>
        </div>

        <div id="results" class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Resultados</h2>
            <div id="certificates-list">
                <p class="text-gray-500">Clique em "Carregar Certificados" para ver os dados.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs,
            deleteDoc,
            doc
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA0VoWMLTJIyI54Pj0P5T75gCH6KpgAcbk",
            authDomain: "mikaelfmts.firebaseapp.com",
            projectId: "mikaelfmts",
            storageBucket: "mikaelfmts.appspot.com",
            messagingSenderId: "516762612351",
            appId: "1:516762612351:web:f8a0f229ffd5def8ec054a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.loadAllCertificates = async function() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('certificates-list');
            
            loading.classList.remove('hidden');
            results.innerHTML = '';

            try {
                const certificatesRef = collection(db, 'certificados');
                const snapshot = await getDocs(certificatesRef);
                
                const certificates = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    certificates.push({
                        id: doc.id,
                        ...data
                    });
                });

                loading.classList.add('hidden');

                if (certificates.length === 0) {
                    results.innerHTML = '<p class="text-gray-500">Nenhum certificado encontrado.</p>';
                    return;
                }

                // Identificar certificados problemáticos
                const problematicCertificates = certificates.filter(cert => {
                    return (
                        cert.titulo === 'teste' ||
                        cert.titulo === null ||
                        cert.titulo === undefined ||
                        cert.titulo === '' ||
                        cert.instituicao === null ||
                        cert.instituicao === undefined ||
                        cert.dataConclusao === '0001-05-05' ||
                        cert.dataConclusao === '2025-04-10'
                    );
                });

                let html = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-green-600">Total de Certificados: ${certificates.length}</h3>
                        <h3 class="text-lg font-semibold text-red-600">Certificados Problemáticos: ${problematicCertificates.length}</h3>
                    </div>
                `;

                if (problematicCertificates.length > 0) {
                    html += `
                        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-3">Certificados Problemáticos:</h4>
                            ${problematicCertificates.map(cert => `
                                <div class="bg-white p-3 mb-2 border border-red-300 rounded">
                                    <p><strong>ID:</strong> ${cert.id}</p>
                                    <p><strong>Título:</strong> ${cert.titulo || 'null/undefined'}</p>
                                    <p><strong>Instituição:</strong> ${cert.instituicao || 'null/undefined'}</p>
                                    <p><strong>Data:</strong> ${cert.dataConclusao || 'null/undefined'}</p>
                                    <p><strong>Status:</strong> ${cert.status || 'null/undefined'}</p>
                                    <button onclick="deleteCertificate('${cert.id}')" class="mt-2 bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-trash mr-1"></i>Excluir
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                html += `
                    <div class="space-y-3">
                        <h4 class="font-semibold text-green-800">Todos os Certificados:</h4>
                        ${certificates.map(cert => `
                            <div class="p-3 border border-gray-300 rounded ${problematicCertificates.some(p => p.id === cert.id) ? 'bg-red-50' : 'bg-green-50'}">
                                <p><strong>ID:</strong> ${cert.id}</p>
                                <p><strong>Título:</strong> ${cert.titulo || 'null/undefined'}</p>
                                <p><strong>Instituição:</strong> ${cert.instituicao || 'null/undefined'}</p>
                                <p><strong>Data:</strong> ${cert.dataConclusao || 'null/undefined'}</p>
                                <p><strong>Status:</strong> ${cert.status || 'null/undefined'}</p>
                                <p><strong>URL:</strong> ${cert.certificadoUrl || 'null/undefined'}</p>
                            </div>
                        `).join('')}
                    </div>
                `;

                results.innerHTML = html;

            } catch (error) {
                loading.classList.add('hidden');
                results.innerHTML = `<p class="text-red-500">Erro ao carregar certificados: ${error.message}</p>`;
                console.error('Erro:', error);
            }
        };

        window.deleteCertificate = async function(certId) {
            if (!confirm('Tem certeza que deseja excluir este certificado?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'certificados', certId));
                alert('Certificado excluído com sucesso!');
                loadAllCertificates(); // Recarregar a lista
            } catch (error) {
                alert('Erro ao excluir certificado: ' + error.message);
                console.error('Erro:', error);
            }
        };

        window.cleanupProblematicCertificates = async function() {
            if (!confirm('Tem certeza que deseja excluir TODOS os certificados problemáticos? Esta ação não pode ser desfeita.')) {
                return;
            }

            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');

            try {
                const certificatesRef = collection(db, 'certificados');
                const snapshot = await getDocs(certificatesRef);
                
                const problematicIds = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isProblematic = (
                        data.titulo === 'teste' ||
                        data.titulo === null ||
                        data.titulo === undefined ||
                        data.titulo === '' ||
                        data.instituicao === null ||
                        data.instituicao === undefined ||
                        data.dataConclusao === '0001-05-05' ||
                        data.dataConclusao === '2025-04-10'
                    );
                    
                    if (isProblematic) {
                        problematicIds.push(doc.id);
                    }
                });

                // Excluir certificados problemáticos
                for (const id of problematicIds) {
                    await deleteDoc(doc(db, 'certificados', id));
                }

                loading.classList.add('hidden');
                alert(`${problematicIds.length} certificados problemáticos foram excluídos!`);
                loadAllCertificates(); // Recarregar a lista

            } catch (error) {
                loading.classList.add('hidden');
                alert('Erro ao limpar certificados: ' + error.message);
                console.error('Erro:', error);
            }
        };
    </script>
</body>
</html>
