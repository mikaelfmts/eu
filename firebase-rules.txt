rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
      // ===== FUNÇÕES DE VALIDAÇÃO =====
    function isValidMessage() {
      return request.resource.data.keys().hasAll(['nome', 'mensagem', 'hora', 'chat_id'])
        && request.resource.data.nome is string
        && request.resource.data.mensagem is string
        && request.resource.data.hora is timestamp
        && request.resource.data.chat_id is string
        && request.resource.data.nome.size() > 0
        && request.resource.data.mensagem.size() > 0
        && request.resource.data.chat_id.size() > 0;
    }    function isValidUpdate() {
      // Permite atualização dos campos de resposta do admin
      // Verifica se apenas campos permitidos estão sendo alterados
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['resposta', 'horaResposta', 'respondido'])
        && request.auth != null
        && request.resource.data.resposta is string
        && request.resource.data.horaResposta is timestamp
        && request.resource.data.respondido is bool;
    }
    
    // ===== REGRAS PARA CURRÍCULO =====
    // Permite leitura pública e escrita autenticada para currículos
    match /curriculum/{curriculumId} {
      // Leitura pública - qualquer pessoa pode ver o currículo
      allow read: if true;
      
      // Escrita apenas para usuários autenticados (incluindo anônimos)
      allow write: if request.auth != null;
      
      // Criação de novos documentos
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['personalData', 'settings', 'metadata'])
        && request.resource.data.metadata.createdAt is timestamp;
      
      // Atualização de documentos existentes
      allow update: if request.auth != null 
        && request.resource.data.metadata.lastUpdated is timestamp;
        // Deletar (qualquer usuário autenticado)
      allow delete: if request.auth != null;
    }    // ===== REGRAS PARA MENSAGENS (SIMPLIFICADAS) =====
    // Sistema de contato do site
    match /mensagens/{messageId} {
      // Permite leitura para todos (necessário para o chat público)
      allow read: if true;
      
      // Permite criação de novas mensagens com validação
      allow create: if isValidMessage();
      
      // Permite atualizações para usuários autenticados (para respostas do admin)
      // Aceita qualquer usuário autenticado como admin válido
      allow update: if request.auth != null 
        && isValidUpdate();
      
      // Não permite deletar mensagens (manter histórico)
      allow delete: if false;
    }
      // ===== REGRAS PARA CONFIGURAÇÕES (SIMPLIFICADAS) =====
    // Configurações do sistema e manutenção
    match /configuracoes/{configId} {
      // Leitura pública para verificar status de manutenção
      allow read: if true;
      
      // Permite modificações para qualquer usuário autenticado
      allow write: if request.auth != null;
    }
      // ===== REGRAS PARA CERTIFICADOS (SIMPLIFICADAS) =====
    // Certificados em progresso
    match /certificados/{certificadoId} {
      // Leitura pública dos certificados
      allow read: if true;
      
      // Permite modificações para qualquer usuário autenticado
      allow write: if request.auth != null;
      
      // Validação de estrutura dos certificados
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['titulo', 'instituicao', 'status'])
        && request.resource.data.status in ['concluido', 'em progresso'];
    }
      // ===== REGRAS PARA USUÁRIOS =====
    // Perfis de usuário
    match /users/{userId} {
      // Usuários podem ler seu próprio perfil
      allow read: if request.auth != null 
        && request.auth.uid == userId;
      
      // Usuários podem criar/atualizar seu próprio perfil
      allow write: if request.auth != null 
        && request.auth.uid == userId;
      
      // Usuários autenticados podem ler todos os perfis
      allow read: if request.auth != null;
    }
      // ===== REGRAS PARA PROJETOS (OPCIONAL) =====
    // Se você quiser adicionar projetos no futuro
    match /projetos/{projetoId} {
      // Leitura pública dos projetos
      allow read: if true;
      
      // Qualquer usuário autenticado pode modificar projetos
      allow write: if request.auth != null;
    }    // ===== REGRAS PARA ANALYTICS (OPCIONAL) =====
    // Dados de analytics do site
    match /analytics/{analyticsId} {
      // Usuários autenticados podem ler analytics
      allow read: if request.auth != null;
      
      // Sistema pode gravar dados de analytics
      allow create: if true;
    }
      // ===== REGRAS PARA GALERIA DE MÍDIA =====
    // Posts da galeria de mídia
    match /galeria_posts/{postId} {
      // Leitura pública dos posts visíveis
      allow read: if true;
      
      // Apenas usuários autenticados podem criar/modificar posts
      allow write: if request.auth != null;
      
      // Validação de estrutura dos posts (atualizada para novo sistema)
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['title', 'createdAt', 'visible'])
        && request.resource.data.title is string
        && request.resource.data.visible is bool
        && (request.resource.data.media is list || request.resource.data.mediaIds is list);
    }
      // ===== REGRAS PARA ARQUIVOS DE MÍDIA =====
    // Coleção que armazena os arquivos como base64 ou URLs
    match /galeria_media/{mediaId} {
      // Leitura pública das mídias
      allow read: if true;
      
      // Apenas usuários autenticados podem criar/modificar mídias
      allow write: if request.auth != null;
      
      // Validação de estrutura das mídias (suporta arquivos e URLs)
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['id', 'name', 'type', 'uploadedAt'])
        && request.resource.data.id is string
        && request.resource.data.name is string
        && request.resource.data.type is string
        && request.resource.data.uploadedAt is timestamp
        && (
          // Para arquivos: deve ter campo 'data' com base64
          (request.resource.data.keys().hasAll(['data']) && request.resource.data.data is string && !request.resource.data.keys().hasAny(['isUrl', 'url']))
          ||
          // Para URLs: deve ter campos 'url' e 'isUrl'
          (request.resource.data.keys().hasAll(['url', 'isUrl']) && request.resource.data.url is string && request.resource.data.isUrl is bool)
        );
    }
      // ===== REGRAS PARA RELATÓRIOS/DASHBOARDS =====
    // Posts de relatórios (Power BI, Excel, Tableau, etc.)
    match /relatorios_posts/{postId} {
      // Leitura pública dos relatórios visíveis
      allow read: if true;
      
      // Apenas usuários autenticados podem criar/modificar posts
      allow write: if request.auth != null;
      
      // Validação de estrutura dos posts de relatórios
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['title', 'createdAt', 'visible', 'type', 'embedUrl'])
        && request.resource.data.title is string
        && request.resource.data.visible is bool
        && request.resource.data.type in ['powerbi', 'excel', 'googlesheets', 'tableau', 'other']
        && request.resource.data.embedUrl is string
        && request.resource.data.createdAt is timestamp;
    }
      // ===== REGRAS PARA CONFIGURAÇÕES DE RELATÓRIOS =====
    // Configurações dos relatórios em destaque
    match /relatorios_config/{configId} {
      // Leitura pública das configurações
      allow read: if true;
      
      // Apenas usuários autenticados podem modificar configurações
      allow write: if request.auth != null;
    }
    
    // ===== REGRAS PARA ARQUIVOS DE RELATÓRIOS =====
    // Coleção que armazena os arquivos de relatórios como base64
    match /relatorios_files/{fileId} {
      // Leitura pública dos arquivos
      allow read: if true;
      
      // Apenas usuários autenticados podem criar/modificar arquivos
      allow write: if request.auth != null;
      
      // Validação de estrutura dos arquivos
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['id', 'name', 'type', 'data', 'uploadedAt'])
        && request.resource.data.id is string
        && request.resource.data.name is string
        && request.resource.data.type is string
        && request.resource.data.data is string
        && request.resource.data.uploadedAt is timestamp;
    }
      // ===== REGRAS PARA CONFIGURAÇÕES DO SITE =====
    // Configurações gerais incluindo mídia em destaque
    match /site_config/{configId} {
      // Leitura pública das configurações
      allow read: if true;
      
      // Apenas usuários autenticados podem modificar configurações
      allow write: if request.auth != null;
    }
    
    // ===== REGRAS PARA PERSONAL HUB =====
    // Sistema Personal Hub integrado ao portfolio
    
    // Regras para diário pessoal
    match /diary/{diaryId} {
      // Apenas o proprietário pode ler suas entradas do diário
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode criar entradas
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Apenas o proprietário pode atualizar suas entradas
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode deletar suas entradas
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para filmes do Personal Hub
    match /movies/{movieId} {
      // Apenas o proprietário pode ler seus filmes
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode adicionar filmes
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Apenas o proprietário pode atualizar seus filmes
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode deletar seus filmes
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para livros do Personal Hub
    match /books/{bookId} {
      // Apenas o proprietário pode ler seus livros
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode adicionar livros
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Apenas o proprietário pode atualizar seus livros
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode deletar seus livros
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para músicas do Personal Hub
    match /music/{musicId} {
      // Apenas o proprietário pode ler suas músicas
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode adicionar músicas
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Apenas o proprietário pode atualizar suas músicas
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode deletar suas músicas
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para atividades/logs do Personal Hub
    match /activities/{activityId} {
      // Apenas o proprietário pode ler suas atividades
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode criar atividades
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Apenas o proprietário pode atualizar suas atividades
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Apenas o proprietário pode deletar suas atividades
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para dados públicos do Personal Hub (estatísticas agregadas - OPCIONAL)
    match /personal_hub_public/{document} {
      // Leitura pública permitida para estatísticas gerais
      allow read: if true;
      
      // Apenas sistema pode escrever (usuários autenticados como admin)
      allow write: if request.auth != null;
    }
    
    // ===== REGRAS PADRÃO =====
    // Negar acesso a qualquer outra coleção não especificada
    match /{document=**} {
      allow read, write: if false;
    }}
}